name: "Release"

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  DEBEZIUM_RELEASE: 3.1.0-Alpha2

jobs:
  github-release:
    uses: ZeroGachis/.github/.github/workflows/gh-release-please.yml@v4
    with:
        major_and_minor_tags: false

  base-build:
    needs: github-release
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
        dockerfile_context: base/
        dockerhub_repository_name: debezium-alpine-base
    secrets: inherit

  base-release:
    needs: github-release
    if: ${{ needs.github-release.outputs.release_created == 'true' }}
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
      dockerfile_context: base/
      dockerhub_repository_name: debezium-alpine-base
      tag: ${{ vars.DEBEZIUM_RELEASE }}
    secrets: inherit

  connect-base-build:
    needs: github-release
    if: ${{ needs.github-release.outputs.release_created == 'false' }}
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
        dockerfile_context: connect-base/
        dockerhub_repository_name: debezium-alpine-connect-base
    secrets: inherit

  connect-base-release:
    needs: github-release
    if: ${{ needs.github-release.outputs.release_created == 'true' }}
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
      dockerfile_context: connect-base/
      dockerhub_repository_name: debezium-alpine-connect-base
      tag: ${{ vars.DEBEZIUM_RELEASE }}
    secrets: inherit

  postgresql-slim-build:
    needs: github-release
    if: ${{ needs.github-release.outputs.release_created == 'false' }}
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
        dockerfile_context: postgresql-slim/
        dockerhub_repository_name: debezium-postgresql-slim
    secrets: inherit

  postgresql-slim-release:
    needs: github-release
    if: ${{ needs.github-release.outputs.release_created == 'true' }}
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
      dockerfile_context: postgresql-slim/
      dockerhub_repository_name: debezium-postgresql-slim
      tag: ${{ vars.DEBEZIUM_RELEASE }}
    secrets: inherit

  snowflake-slim-build:
    needs: github-release
    if: ${{ needs.github-release.outputs.release_created == 'false' }}
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
        dockerfile_context: snowflake-slim/
        dockerhub_repository_name: debezium-snowflake-slim
    secrets: inherit

  snowflake-slim-release:
    needs: github-release
    if: ${{ needs.github-release.outputs.release_created == 'true' }}
    uses: ZeroGachis/.github/.github/workflows/build-push-image-to-dockerhub.yml@v4
    with:
      dockerfile_context: snowflake-slim/
      dockerhub_repository_name: debezium-snowflake-slim
      tag: ${{ vars.DEBEZIUM_RELEASE }}
    secrets: inherit
